# æ¶æ„æ¦‚è¿° <Badge type="info" text="Developer" />

ChatAI Plugin é‡‡ç”¨**æ¨¡å—åŒ–åˆ†å±‚æ¶æ„**è®¾è®¡ï¼ŒåŸºäº MCP æ ‡å‡†å®ç°å·¥å…·è°ƒç”¨ç³»ç»Ÿã€‚

::: tip é˜…è¯»æœ¬æ–‡æ¡£å‰
å»ºè®®å…ˆäº†è§£ [MCP (Model Context Protocol)](https://modelcontextprotocol.io/) åè®®åŸºç¡€çŸ¥è¯†ã€‚
:::

## æ¶æ„å›¾ {#architecture-diagram}

```mermaid
graph TB
    subgraph "ä¸šåŠ¡å±‚ Apps"
        CHAT[chat.js]
        LISTENER[ChatListener.js]
    end
    
    subgraph "Skills Agent å±‚"
        SA[SkillsAgent<br/>ç»Ÿä¸€æŠ€èƒ½æ¥å£ã€æƒé™è¿‡æ»¤ã€å‚æ•°è‡ªåŠ¨å¡«å……]
    end
    
    subgraph "MCP å±‚"
        MM[McpManager<br/>å·¥å…·æ³¨å†Œç®¡ç†]
        MC[McpClient<br/>åè®®ä¼ è¾“å®ç°]
        BMS[BuiltinMcpServer<br/>å†…ç½®å·¥å…·ç®¡ç†]
    end
    
    subgraph "å·¥å…·å®ç°å±‚"
        BT[å†…ç½®å·¥å…·<br/>src/mcp/tools]
        JT[JS å·¥å…·<br/>data/tools]
        EXT[å¤–éƒ¨ MCP æœåŠ¡å™¨<br/>npm/stdio/SSE/HTTP]
    end
    
    CHAT --> SA
    LISTENER --> CHAT
    SA --> MM
    MM --> MC
    MM --> BMS
    MC --> EXT
    BMS --> BT
    BMS --> JT
```

## æ ¸å¿ƒæ¦‚å¿µ {#core-concepts}

### ä¸‰å±‚æ¶æ„ {#three-layers}

::: info åˆ†å±‚è®¾è®¡åŸåˆ™
æ¯å±‚åªä¾èµ–ä¸‹å±‚ï¼Œä¸ä¾èµ–ä¸Šå±‚ï¼Œä¿è¯æ¨¡å—è§£è€¦å’Œå¯æµ‹è¯•æ€§ã€‚
:::

| å±‚çº§ | è¯´æ˜ | ä¸»è¦æ¨¡å— | èŒè´£ |
|:-----|:-----|:---------|:-----|
| **åº”ç”¨å±‚** | æ¶ˆæ¯å¤„ç†ã€å‘½ä»¤å“åº” | `apps/`, `ChatListener` | æ¥æ”¶ Yunzai æ¶ˆæ¯äº‹ä»¶ï¼Œè·¯ç”±åˆ°å¯¹åº”å¤„ç†å™¨ |
| **æœåŠ¡å±‚** | ä¸šåŠ¡é€»è¾‘ã€API æœåŠ¡ | `services/`, `agent/` | LLM è°ƒç”¨ã€ä¸Šä¸‹æ–‡ç®¡ç†ã€å·¥å…·ç¼–æ’ |
| **æ ¸å¿ƒå±‚** | åŸºç¡€è®¾æ–½ã€é€‚é…å™¨ | `core/`, `mcp/` | å¤šæ¨¡å‹é€‚é…ã€MCP åè®®å®ç°ã€ç¼“å­˜å­˜å‚¨ |

### MCP ç³»ç»Ÿ {#mcp-system}

::: tip MCP åè®®
**MCP (Model Context Protocol)** æ˜¯ Anthropic æå‡ºçš„å¼€æ”¾æ ‡å‡†ï¼Œç”¨äºå®šä¹‰ AI ä¸å·¥å…·çš„äº¤äº’æ–¹å¼ã€‚
:::

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|:-----|:-----|:-----|
| **McpManager** | `src/mcp/McpManager.js` | ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å·¥å…·æ¥æºï¼Œæä¾›å·¥å…·æ³¨å†Œã€æŸ¥è¯¢ã€è°ƒç”¨æ¥å£ |
| **McpClient** | `src/mcp/McpClient.js` | MCP åè®®å®¢æˆ·ç«¯ï¼Œæ”¯æŒ stdio/npm/SSE/HTTP å¤šç§ä¼ è¾“ |
| **BuiltinMcpServer** | `src/mcp/BuiltinMcpServer.js` | å†…ç½®å·¥å…·æœåŠ¡å™¨ï¼Œç®¡ç† 22 ä¸ªç±»åˆ«çš„å·¥å…·å’Œè‡ªå®šä¹‰ JS å·¥å…· |

### Skills Agent {#skills-agent}

**Skills Agent** æ˜¯ MCP ä¹‹ä¸Šçš„ä¸šåŠ¡æŠ½è±¡å±‚ï¼Œå®šä¹‰äº `src/services/agent/SkillsAgent.js`ï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|:-----|:-----|
| **ç»Ÿä¸€æŠ€èƒ½æ¥å£** | æ•´åˆæ‰€æœ‰å·¥å…·æ¥æºä¸ºç»Ÿä¸€çš„"æŠ€èƒ½"æ¦‚å¿µ |
| **æƒé™è¿‡æ»¤** | æ ¹æ®ç”¨æˆ·/ç¾¤ç»„æƒé™è¿‡æ»¤å¯ç”¨å·¥å…· |
| **å‚æ•°è‡ªåŠ¨å¡«å……** | è‡ªåŠ¨æ³¨å…¥ user_idã€group_id ç­‰ä¸Šä¸‹æ–‡å‚æ•° |
| **é¢„è®¾çº§æ§åˆ¶** | æ”¯æŒé¢„è®¾çº§åˆ«çš„å·¥å…·ç™½åå•/é»‘åå• |

## ç›®å½•ç»“æ„ {#directory-structure}

::: details å®Œæ•´ç›®å½•ç»“æ„ï¼ˆç‚¹å‡»å±•å¼€ï¼‰
```
chatgpt-plugin/
â”œâ”€â”€ apps/                    # åº”ç”¨æ¨¡å—ï¼ˆYunzai æ’ä»¶å…¥å£ï¼‰
â”‚   â”œâ”€â”€ chat.js              # ä¸»èŠå¤©å¤„ç†
â”‚   â”œâ”€â”€ Commands.js          # å‘½ä»¤å¤„ç†
â”‚   â”œâ”€â”€ Management.js        # ç®¡ç†å‘½ä»¤
â”‚   â””â”€â”€ ...                  # å…¶ä»–åŠŸèƒ½æ¨¡å—
â”œâ”€â”€ config/                  # é…ç½®ç®¡ç†
â”œâ”€â”€ data/                    # è¿è¡Œæ—¶æ•°æ®
â”‚   â”œâ”€â”€ presets/             # é¢„è®¾æ–‡ä»¶
â”‚   â”œâ”€â”€ tools/               # è‡ªå®šä¹‰ JS å·¥å…·
â”‚   â”œâ”€â”€ mcp-servers.json     # MCP æœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ chatai.db            # SQLite æ•°æ®åº“
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒå±‚
â”‚   â”‚   â”œâ”€â”€ adapters/        # LLM é€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractClient.js  # æŠ½è±¡åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ openai/      # OpenAI å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ claude/      # Claude å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â””â”€â”€ gemini/      # Gemini å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ types/           # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ mcp/                 # MCP ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ McpManager.js    # MCP ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ McpClient.js     # MCP å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ BuiltinMcpServer.js  # å†…ç½®å·¥å…·æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ tools/           # å†…ç½®å·¥å…·ï¼ˆ22ä¸ªç±»åˆ«ï¼‰
â”‚   â””â”€â”€ services/            # æœåŠ¡å±‚
â”‚       â”œâ”€â”€ agent/           # Skills Agent
â”‚       â”œâ”€â”€ llm/             # LLM æœåŠ¡
â”‚       â”œâ”€â”€ storage/         # å­˜å‚¨æœåŠ¡
â”‚       â”œâ”€â”€ routes/          # API è·¯ç”±
â”‚       â””â”€â”€ webServer.js     # Web æœåŠ¡
â””â”€â”€ index.js                 # æ’ä»¶å…¥å£
```
:::

**æ ¸å¿ƒç›®å½•è¯´æ˜ï¼š**

| ç›®å½• | è¯´æ˜ | é‡è¦æ–‡ä»¶ |
|:-----|:-----|:---------|
| `apps/` | Yunzai æ’ä»¶å…¥å£ | `chat.js` ä¸»èŠå¤©å¤„ç† |
| `src/core/adapters/` | LLM é€‚é…å™¨ | `AbstractClient.js` æŠ½è±¡åŸºç±» |
| `src/mcp/` | MCP ç³»ç»Ÿ | `McpManager.js` å·¥å…·ç®¡ç† |
| `src/services/` | æœåŠ¡å±‚ | `llm/`, `agent/`, `storage/` |
| `data/tools/` | è‡ªå®šä¹‰å·¥å…· | ç”¨æˆ· JS å·¥å…·è„šæœ¬ |

## æ ¸å¿ƒç»„ä»¶ {#core-components}

::: info ç»„ä»¶ä¾èµ–å…³ç³»
ç»„ä»¶æŒ‰ä¾èµ–é¡ºåºæ’åˆ—ï¼Œä¸Šå±‚ç»„ä»¶ä¾èµ–ä¸‹å±‚ç»„ä»¶ã€‚
:::

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | å±‚çº§ |
|:-----|:-----|:-----|:----:|
| **AbstractClient** | `src/core/adapters/AbstractClient.js` | LLM é€‚é…å™¨æŠ½è±¡åŸºç±»ï¼Œå·¥å…·è°ƒç”¨è§£æ | æ ¸å¿ƒ |
| **OpenAIClient** | `src/core/adapters/openai/OpenAIClient.js` | OpenAI/å…¼å®¹ API å®¢æˆ·ç«¯ | æ ¸å¿ƒ |
| **McpManager** | `src/mcp/McpManager.js` | å·¥å…·æ³¨å†Œã€æŸ¥è¯¢ã€è°ƒç”¨ç®¡ç† | æ ¸å¿ƒ |
| **McpClient** | `src/mcp/McpClient.js` | MCP åè®®å®¢æˆ·ç«¯ï¼ˆstdio/npm/SSE/HTTPï¼‰ | æ ¸å¿ƒ |
| **BuiltinMcpServer** | `src/mcp/BuiltinMcpServer.js` | å†…ç½®å·¥å…·æœåŠ¡å™¨ã€ä¸Šä¸‹æ–‡ç®¡ç†ã€çƒ­é‡è½½ | æ ¸å¿ƒ |
| **SkillsAgent** | `src/services/agent/SkillsAgent.js` | æŠ€èƒ½ä»£ç†ã€æƒé™æ§åˆ¶ã€å‚æ•°å¡«å…… | æœåŠ¡ |
| **ToolFilterService** | `src/services/tools/ToolFilterService.js` | å·¥å…·è¿‡æ»¤ã€é»‘ç™½åå• | æœåŠ¡ |

## è®¾è®¡åŸåˆ™ {#design-principles}

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|:-----|:-----|:---------|
| ğŸ§© **æ¨¡å—åŒ–** | åŠŸèƒ½è§£è€¦ï¼Œç‹¬ç«‹ç»´æŠ¤ | æ¯ä¸ªæ¨¡å—å•ç‹¬ç›®å½•ï¼Œæ˜ç¡®å¯¼å‡ºæ¥å£ |
| ğŸ”Œ **å¯æ‰©å±•** | æ”¯æŒè‡ªå®šä¹‰å·¥å…·å’Œé€‚é…å™¨ | æŠ½è±¡åŸºç±» + æ’ä»¶æœºåˆ¶ |
| ğŸ“‹ **æ ‡å‡†åŒ–** | éµå¾ª MCP åè®®è§„èŒƒ | å®ç° MCP æ ‡å‡†æ¥å£ |
| ğŸ”’ **å®‰å…¨æ€§** | å®Œå–„çš„æƒé™æ§åˆ¶æœºåˆ¶ | å¤šå±‚æƒé™è¿‡æ»¤ã€å±é™©å‘½ä»¤æ‹¦æˆª |

## è¯¦ç»†æ–‡æ¡£ {#detailed-docs}

::: tip ğŸ“š æ·±å…¥äº†è§£å„æ¨¡å—
:::

| æ–‡æ¡£ | å†…å®¹ | æ¨èé˜…è¯» |
|:-----|:-----|:--------:|
| [åˆ†å±‚æ¶æ„](./layers) | è¯¦ç»†çš„å±‚æ¬¡ç»“æ„è¯´æ˜ | â­â­ |
| [MCP ç³»ç»Ÿ](./mcp) | MCP åè®®å®ç°è¯¦è§£ | â­â­â­ |
| [Skills Agent](./skills-agent) | æŠ€èƒ½ä»£ç†ç³»ç»Ÿ | â­â­ |
| [æ•°æ®æµ](./data-flow) | è¯·æ±‚å¤„ç†æµç¨‹ | â­â­â­ |
| [LLM é€‚é…å™¨](./adapters) | å¤šæ¨¡å‹é€‚é…å®ç° | â­â­â­ |
| [å­˜å‚¨ç³»ç»Ÿ](./storage) | æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ | â­â­ |
